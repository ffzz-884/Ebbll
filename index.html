<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<style>
  :root{
    --bg:#f0f0f0;
    --card:#ffffff;
    --muted:#666666;
    --accent:#2e6da4;
    --success:#5cb85c;
    --danger:#d9534f;
  }

  * { box-sizing: border-box; }

  html,body{
    height:100%;
    font-size:18px;
    -webkit-text-size-adjust:100%;
  }

  body {
    margin:0;
    background:var(--bg);
    font-family:Arial,Helvetica,sans-serif;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:10px;
    color:#000;
  }

  .container{
    width: 450px;
    margin: 0 auto;
    background:var(--card);
    border:1px solid #cccccc;
    border-radius:6px;
    padding:12px;
  }

  .title {
    font-weight:bold;
    font-size:20px;
    margin-bottom:15px;
    text-align:center;
    padding:10px;
    border-radius:3px;
  }
  .title:empty::before { content: "\00a0"; visibility: hidden; }

  .controls {
    display:flex;
    gap:8px;
    margin:15px 0;
    flex-wrap:wrap;
  }

  input[type="text"]{
    box-sizing:border-box;
    padding:8px 10px;
    font-size:16px;
    border:1px solid #999;
    border-radius:5px;
    height:36px;
    background:#fff;
    width:100%;
  }

  .flex-1 { flex:1; }
  .flex-3 { flex:3; }

  button {
    padding:8px 10px;
    font-size:14px;
    border-radius:5px;
    border:1px solid transparent;
    cursor:pointer;
    background:transparent;
  }

  .btn-primary { background:var(--accent); color:#fff; }
  .btn-success { background:var(--success); color:#fff; }
  .btn-danger  { background:var(--danger);  color:#fff; }

  .lines {
    display:flex;
    flex-direction:column;
    gap:8px;
    max-height: 320px;
    overflow:auto;
    width:100%;
  }

  .line {
    display:flex;
    gap:8px;
    align-items:center;
    padding:8px;
    border:1px solid #e0e0e0;
    border-radius:6px;
    background:#fff;
  }

  .line-name {
    flex:1 1 auto;
    min-width:0;
    font-size:18px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }

  .line-actions {
    display:flex;
    gap:8px;
    margin-left:auto;
    align-items:center;
  }

  .line button {
    padding:6px 8px;
    font-size:14px;
    min-width:72px;
    min-height:32px;
    border:0;
  }

  .clear-floating {
    position:fixed;
    right:18px;
    bottom:18px;
    z-index:1000;
    border-radius:6px;
    padding:10px 14px;
  }

  .btn-small {
    padding:5px 8px;
    font-size:13px;
    min-width:64px;
  }

  .btn-success.btn-small { background:var(--success); color:#fff; border-color:transparent; }
  .btn-danger.btn-small  { background:var(--danger);  color:#fff; border-color:transparent; }
  </style>
</head>
<body>
  <div class="container">
    
    <form class="controls">
      <input id="addText" type="text" class="flex-3" placeholder="" />
      <button id="addLineBtn" class="btn-primary flex-1">Add</button>
    </form>
    
    <div class="panel">
      <div id="linesContainer" class="lines" aria-live="polite"></div>
    </div>
    
    <!-- floating clear button at bottom-right -->
    <button id="clearAll" class="btn-danger clear-floating">Clear</button>
    
  </div>

  <script>
    // Original JavaScript code remains unchanged
    const LINK_TEMPLATE = 'https://cbetaonline.cn/getData.php?type=ebooks_export&export_type=mobi&work=';

    // Gist configuration (fill these with your values to enable saving)
    const GIST_ID = '72d7d3c90e10fdea9c923703fef35b93';       // e.g. 'a1b2c3d4e5f6...'
    const FILE_NAME = 'gistfile1.txt';     // e.g. 'notes.txt' (exact filename inside the gist)
    let GIST_TOKEN = null;

    // Gist UI elements
    const linesContainer = document.getElementById('linesContainer');
    const addTextInput = document.getElementById('addText');
    const addLineBtn = document.getElementById('addLineBtn');
    const clearBtn = document.getElementById('clearAll');
    const titleDiv = document.querySelector('.title');

    let lines = [];

    async function loadToken() {
      try {
        const raw = 'LSI1Oz0lFTsgJxd2ewkOYXwBBQJxYz0kew0SCicQcnJwDD0AKBp1ICMCBioFMgkKfDh2IAkkOgoHIw4eGSIqKRIOfy4pIAsScww5FSESA3kYG3wUDiI7YwkwMBg4';
        const key = 'JKASHG';

        const base64Decoded = atob(raw);
        
        let result = '';
        // XOR decryption
        for (let i = 0; i < base64Decoded.length; i++) {
            result += String.fromCharCode(base64Decoded.charCodeAt(i) ^ key.charCodeAt(i % key.length));
        }

        GIST_TOKEN = result;
      } catch (err) {
        console.warn('Could not decrypt token. ', err && err.message || err);
        GIST_TOKEN = null;
      }
    }

    // Load gist file content via GitHub API (CORS supported)
    async function loadGistFile() {
      if (!GIST_ID || !FILE_NAME) {
        alert('GIST_ID and FILE_NAME must be set in the script.');
        return;
      }
      try {
        const apiUrl = 'https://api.github.com/gists/' + encodeURIComponent(GIST_ID);
        const res = await fetch(apiUrl);
        if (!res.ok) throw new Error('Failed to fetch gist: ' + res.status);
        const gist = await res.json();

        // Ensure files object and the specific file exist
        if (!gist.files || !Object.prototype.hasOwnProperty.call(gist.files, FILE_NAME)) {
          lines = [];
          renderList();
        }

        // Safely read content; treat null/undefined as empty string
        const file = gist.files[FILE_NAME];
        let content = file && file.content;
        if (content == null) content = '';
        if (typeof content !== 'string') content = String(content);

        // If content is empty, produce an empty lines array (do NOT treat as "not found")
        lines = content === '' ? [] : content.split(/\r?\n/);
        renderList();
      } catch (err) {
        alert('Load error: ' + err.message);
        console.error('Fetch error when loading gist file:', err);
      }
    }

    // Render lines into the new container. Each line has Download and Remove.
    function renderList() {
      linesContainer.innerHTML = '';
      lines.forEach((ln, idx) => {
        const row = document.createElement('div');
        row.className = 'line';
        // name
        const name = document.createElement('div');
        name.className = 'line-name';
        name.textContent = ln;

        // actions wrapper (right-aligned)
        const actions = document.createElement('div');
        actions.className = 'line-actions';
        
        // download button (green)
        const dl = document.createElement('button');
        dl.type = 'button';
        dl.className = 'btn-success btn-small';
        dl.textContent = 'Download';
        dl.dataset.index = String(idx);
        
        // remove button (red)
        const rm = document.createElement('button');
        rm.type = 'button';
        rm.className = 'btn-danger btn-small';
        rm.textContent = 'Remove';
        rm.dataset.index = String(idx);

        actions.appendChild(dl);
        actions.appendChild(rm);

        row.appendChild(name);
        row.appendChild(actions);

        linesContainer.appendChild(row);
      });
      if (titleDiv) titleDiv.textContent = '';
    }

    // Delegated click handling for per-line download/remove
    linesContainer.addEventListener('click', async (e) => {
      const btn = e.target;
      if (!btn || !btn.dataset || typeof btn.dataset.index === 'undefined') return;
      const idx = Number(btn.dataset.index);
      if (Number.isNaN(idx) || idx < 0 || idx >= lines.length) return;

      if (btn.textContent && btn.textContent.toLowerCase().includes('download')) {
        const raw = String(lines[idx] || '').trim();
        const first = raw.split(/\s+/)[0] || '';
        if (!first) { alert('Selected line does not contain a code.'); return; }
        const code = normalizeCode(first);
        const url = buildUrl(code);
        window.open(url, '_blank');
        return;
      }

      if (btn.textContent && btn.textContent.toLowerCase().includes('remove')) {
        // remove this line (safe save)
        const newLines = lines.slice();
        newLines.splice(idx, 1);

        // disable UI while saving
        btn.disabled = true;
        addLineBtn.disabled = true;
        addTextInput.disabled = true;
        try {
          const ok = await updateGistFile(newLines);
          if (ok) {
            lines = newLines;
            renderList();
          }
        } finally {
          btn.disabled = false;
          addLineBtn.disabled = false;
          addTextInput.disabled = false;
        }
        return;
      }
    });

    // Replace existing updateGistFile with this version that accepts a candidate lines array
    async function updateGistFile(linesParam) {
      if (!GIST_ID || !FILE_NAME) {
        alert('Gist config not set. Set GIST_ID and FILE_NAME inside the script to enable saving.');
        return false;
      }
      if (!GIST_TOKEN) {
        alert('Gist token not found.');
        return false;
      }
      const content = (Array.isArray(linesParam) ? linesParam : lines).join('\n');
      try {
        const res = await fetch('https://api.github.com/gists/' + encodeURIComponent(GIST_ID), {
          method: 'PATCH',
          headers: {
            'Authorization': 'token ' + GIST_TOKEN,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ files: { [FILE_NAME]: { content } } })
        });
        if (!res.ok) {
          const err = await res.json().catch(()=>({message:res.statusText}));
          throw new Error(err.message || 'Failed to save gist: ' + res.status);
        }
        return true;
      } catch (err) {
        alert('Save error: ' + err.message);
        console.error('Gist save error:', err);
        return false;
      }
    }

    addLineBtn.addEventListener('click', async (ev) => {
      ev.preventDefault();
      const txt = String(addTextInput.value || '').trim();
      if (!txt) return;

      const newLines = lines.concat(txt);

      addLineBtn.disabled = true;
      addTextInput.disabled = true;
      try {
        const ok = await updateGistFile(newLines);
        if (ok) {
          lines = newLines;
          addTextInput.value = '';
          renderList();
        }
      } finally {
        addLineBtn.disabled = false;
        addTextInput.disabled = false;
      }
    });

    clearBtn.addEventListener('click', async () => {
      if (lines.length === 0) { return; }
      if (!confirm('Clear all lines? This cannot be undone.')) return;

      const newLines = [];

      clearBtn.disabled = true;
      addLineBtn.disabled = true;
      addTextInput.disabled = true;
      try {
        const ok = await updateGistFile(newLines);
        if (ok) {
          lines = newLines;
          renderList();
        }
      } finally {
        clearBtn.disabled = false;
        addLineBtn.disabled = false;
        addTextInput.disabled = false;
      }
    });

    function normalizeCode(raw) {
      const str = String(raw || '').trim();
      return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
    }

    function buildUrl(code) {
      return LINK_TEMPLATE + encodeURIComponent(code);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // try to load token first (if present), then load gist content
      await loadToken();
      await loadGistFile();
    });
  </script>
</body>

</html>
