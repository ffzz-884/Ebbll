<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<style>
  /* Kindle-optimized styles */
  :root{
    --bg:#f0f0f0;
    --card:#ffffff;
    --muted:#666666;
    --accent:#2e6da4;
    --success:#5cb85c;
    --danger:#d9534f;
  }
  
  * {
    box-sizing: border-box;
  }
  
  html,body{
    height:100%;
    font-size:18px; /* Larger base font size for Kindle */
    -webkit-text-size-adjust:100%;
  }
  
  body {
    margin:0;
    background:var(--bg);
    font-family:Arial,Helvetica,sans-serif; /* Kindle compatible fonts */
    display:flex;
    align-items:center;
    justify-content:center;
    padding:10px;
    color:#000000;
  }
  
  .container{
    width:100%;
    max-width:100%;
    background:var(--card);
    border:2px solid #cccccc;
    border-radius:5px;
    padding:15px;
  }
  
  .title { 
    font-weight:bold; 
    font-size:20px; 
    margin-bottom:15px; 
    text-align:center;
    padding:10px;
    background:#e6e6e6;
    border-radius:3px;
  }
  
  .title:empty::before {
    content: "\00a0";
    visibility: hidden;
  }

  .row { 
    display:flex; 
    gap:10px; 
    align-items:center; 
    margin-bottom:15px;
  }
  
  .top-row { 
    margin-bottom:15px; 
  }
  
  label { 
    display:block; 
    color:var(--muted); 
    font-size:16px; 
    margin-bottom:8px; 
  }
  
  input[type="text"], select {
    box-sizing:border-box;
    padding:12px;
    font-size:18px;
    border:2px solid #999999;
    border-radius:5px;
    height:50px; /* Larger touch targets */
    background:#fff;
    width:100%;
  }
  
  select {
    flex: 2;
    height: 250px;
    font-family: Arial, monospace;
    font-size: 20px;
  }

  option {
    padding: 6px 2px;
  }
  
  .flex-1 { 
    flex:1; 
  }

   .flex-2 { 
    flex:2; 
  }

  button {
    padding:15px 20px;
    font-size:18px;
    border-radius:5px;
    border:2px solid transparent;
    cursor:pointer;
    min-height:50px;
    min-width:120px;
  }
  
  .btn-primary { 
    background:var(--accent); 
    color:#fff; 
  }
  
  .btn-success { 
    background:var(--success); 
    color:#fff; 
  }
  
  .btn-secondary { 
    background:#f3f4f6; 
    color:#000000; 
  }
  
  .btn-danger { 
    background:var(--danger); 
    color:#fff; 
  }
  
  .controls { 
    display:flex; 
    gap:10px; 
    margin:15px 0;
    flex-wrap:wrap;
  }
  
  .muted { 
    color:var(--muted); 
    font-size:14px; 
    margin-top:10px; 
    text-align:center;
  }
  
  .panel { 
    display:flex;
    gap:15px;
  }
  
  .side-buttons { 
    flex:1;
    display:flex; 
    gap:10px;
    flex-direction: column;
  }
  
  .side-buttons button {
    min-width:100px;
  }

  select {
    width: 100%;
  }
</style>
</head>
<body>
  <div class="container">
    
    <div class="controls">
      <input id="addText" type="text" class="flex-2" placeholder="new line..." />
      <button id="addLineBtn" class="flex-1">Add</button>
    </div>
    
    <div class="title"></div>
    
    <div class="panel">
      <select id="linesList" size="8">
      </select>
      <div class="side-buttons">
        <button id="downloadSelected" class="btn-success">Download</button>
        <button id="removeSelected" class="btn-danger">Remove</button>
        <button id="clearAll" class="btn-danger">Clear</button>
      </div>
    </div>
    
  </div>

  <script>
    // Original JavaScript code remains unchanged
    const LINK_TEMPLATE = 'https://cbetaonline.cn/getData.php?type=ebooks_export&export_type=mobi&work=';

    // Gist configuration (fill these with your values to enable saving)
    const GIST_ID = '72d7d3c90e10fdea9c923703fef35b93';       // e.g. 'a1b2c3d4e5f6...'
    const FILE_NAME = 'gistfile1.txt';     // e.g. 'notes.txt' (exact filename inside the gist)
    let GIST_TOKEN = null;

    // Gist UI elements
    const linesList = document.getElementById('linesList');
    const removeBtn = document.getElementById('removeSelected');
    const addTextInput = document.getElementById('addText');
    const addLineBtn = document.getElementById('addLineBtn');
    const clearBtn = document.getElementById('clearAll');
    const downloadSelectedBtn = document.getElementById('downloadSelected');
    const titleDiv = document.querySelector('.title');

    let lines = [];

    // Load token from ./token (same directory).
    async function loadToken() {
      try {
        const res = await fetch('./toen');
        if (!res.ok) throw new Error('Token file not found: ' + res.status);
        const raw = await res.text();
        const key = 'AJAFJK';

        // XOR-decrypt
        let result = "";
        for (let i = 0; i < raw.length; i++) {
            result += String.fromCharCode(raw.charCodeAt(i) ^ key.charCodeAt(i % key.length));
        }
        GIST_TOKEN = result;
      } catch (err) {
        console.warn('Could not load/decrypt token file ./token:', err && err.message || err);
        GIST_TOKEN = null;
      }
    }

    // Load gist file content via GitHub API (CORS supported)
    async function loadGistFile() {
      if (!GIST_ID || !FILE_NAME) {
        alert('GIST_ID and FILE_NAME must be set in the script.');
        return;
      }
      try {
        const apiUrl = 'https://api.github.com/gists/' + encodeURIComponent(GIST_ID);
        const res = await fetch(apiUrl);
        if (!res.ok) throw new Error('Failed to fetch gist: ' + res.status);
        const gist = await res.json();

        // Ensure files object and the specific file exist
        if (!gist.files || !Object.prototype.hasOwnProperty.call(gist.files, FILE_NAME)) {
          lines = [];
          renderList();
        }

        // Safely read content; treat null/undefined as empty string
        const file = gist.files[FILE_NAME];
        let content = file && file.content;
        if (content == null) content = '';
        if (typeof content !== 'string') content = String(content);

        // If content is empty, produce an empty lines array (do NOT treat as "not found")
        lines = content === '' ? [] : content.split(/\r?\n/);
        renderList();
      } catch (err) {
        alert('Load error: ' + err.message);
        console.error('Fetch error when loading gist file:', err);
      }
    }

    function renderList() {
      linesList.innerHTML = '';
      lines.forEach((ln, idx) => {
        const opt = document.createElement('option');
        opt.value = String(idx);
        opt.textContent = ln;
        linesList.appendChild(opt);
      });
      if (titleDiv) titleDiv.textContent = '';
    }

    function selectedIndex() {
      return linesList.selectedIndex;
    }

    // Replace existing updateGistFile with this version that accepts a candidate lines array
    async function updateGistFile(linesParam) {
      if (!GIST_ID || !FILE_NAME) {
        alert('Gist config not set. Set GIST_ID and FILE_NAME inside the script to enable saving.');
        return false;
      }
      if (!GIST_TOKEN) {
        alert('Gist token not found.');
        return false;
      }
      const content = (Array.isArray(linesParam) ? linesParam : lines).join('\n');
      try {
        const res = await fetch('https://api.github.com/gists/' + encodeURIComponent(GIST_ID), {
          method: 'PATCH',
          headers: {
            'Authorization': 'token ' + GIST_TOKEN,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ files: { [FILE_NAME]: { content } } })
        });
        if (!res.ok) {
          const err = await res.json().catch(()=>({message:res.statusText}));
          throw new Error(err.message || 'Failed to save gist: ' + res.status);
        }
        return true;
      } catch (err) {
        alert('Save error: ' + err.message);
        console.error('Gist save error:', err);
        return false;
      }
    }

    downloadSelectedBtn.addEventListener('click', () => {
      const idx = selectedIndex();
      if (idx < 0) { alert('Please select a line to download.'); return; }
      const raw = String(lines[idx] || '').trim();
      const first = raw.split(/\s+/)[0] || '';
      if (!first) { alert('Selected line does not contain a code.'); return; }
      const code = normalizeCode(first);
      const url = buildUrl(code);
      window.open(url, '_blank');
    });

    // update title to show selected item's first whitespace-split token
    linesList.addEventListener('change', () => {
      const idx = selectedIndex();
      if (idx < 0) {
        if (titleDiv) titleDiv.textContent = '';
        return;
      }
      const raw = String(lines[idx] || '').trim();
      const first = raw.split(/\s+/)[0] || '';
      if (titleDiv) titleDiv.textContent = first;
    });

    // Update remove handler: only update list after successful save
    removeBtn.addEventListener('click', async () => {
      const idx = selectedIndex();
      if (idx < 0) { alert('Please select a line to remove.'); return; }

      // prepare new lines without mutating current lines
      const newLines = lines.slice();
      newLines.splice(idx, 1);

      // disable controls while saving
      removeBtn.disabled = true;
      addLineBtn.disabled = true;
      addTextInput.disabled = true;
      try {
        const ok = await updateGistFile(newLines);
        if (ok) {
          lines = newLines;
          renderList();
        }
      } finally {
        // re-enable controls
        removeBtn.disabled = false;
        addLineBtn.disabled = false;
        addTextInput.disabled = false;
      }
    });

    // Update add handler: only update list after successful save
    addLineBtn.addEventListener('click', async () => {
      const txt = String(addTextInput.value || '').trim();
      if (!txt) return;

      const newLines = lines.concat(txt);

      // disable controls while saving
      addLineBtn.disabled = true;
      addTextInput.disabled = true;
      removeBtn.disabled = true;
      try {
        const ok = await updateGistFile(newLines);
        if (ok) {
          lines = newLines;
          addTextInput.value = '';
          renderList();
        }
      } finally {
        // re-enable controls
        addLineBtn.disabled = false;
        addTextInput.disabled = false;
        removeBtn.disabled = false;
      }
    });

    // Clear all lines handler: only clear locally after successful gist update
    clearBtn.addEventListener('click', async () => {
      if (lines.length === 0) { return; }
      if (!confirm('Clear all lines? This cannot be undone.')) return;

      const newLines = [];

      // disable controls while saving
      clearBtn.disabled = true;
      removeBtn.disabled = true;
      addLineBtn.disabled = true;
      addTextInput.disabled = true;
      try {
        const ok = await updateGistFile(newLines);
        if (ok) {
          lines = newLines;
          renderList();
        }
      } finally {
        // re-enable controls
        clearBtn.disabled = false;
        removeBtn.disabled = false;
        addLineBtn.disabled = false;
        addTextInput.disabled = false;
      }
    });

    function normalizeCode(raw) {
      const str = String(raw || '').trim();
      return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
    }

    // Build URL by concatenation instead of replace
    function buildUrl(code) {
      return LINK_TEMPLATE + encodeURIComponent(code);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // try to load token first (if present), then load gist content
      await loadToken();
      await loadGistFile();
    });
  </script>
</body>

</html>
